---
description: "Context Engineering增强的实施计划命令 - 深度技术分析和智能设计生成"
scripts:
  sh: scripts/bash/get-feature-info.sh --json "{ARGS}"
  ps: scripts/powershell/get-feature-info.ps1 -Json "{ARGS}"
---

# Context Engineering Enhanced /plan Command

**上下文工程模式**: 智能技术分析和验证驱动的设计生成
**深度集成**: 代码库感知、架构优化、风险预测

## Context Engineering Enhanced 执行流程

### 阶段1: 上下文加载和深度分析
```
1.1 增强脚本执行和信息收集
   → 从仓库根目录运行脚本 `{SCRIPT}`
   → 解析JSON输出获取功能信息:
     * FEATURE_SPEC: 功能规范文件路径
     * IMPLEMENTATION_PLAN: 实施计划文件路径
     * FEATURE_DIR: 功能目录路径
     * BRANCH_NAME: 当前分支名称
   → **重要**: 只能运行此脚本一次
   → 所有文件路径必须是绝对路径

1.2 智能上下文构建
   → 深度分析功能规范中的需求和约束
   → 扫描代码库识别相关的架构模式
   → 分析现有的数据模型和API设计
   → 评估技术栈的能力和限制
   → 收集相关的测试策略和质量标准

1.3 代码库智能分析
   → 识别可复用的组件和服务
   → 分析现有的错误处理和日志模式
   → 评估性能瓶颈和优化机会
   → 检测安全模式和合规要求
   → 分析部署和运维约束
```

### 阶段2: 增强宪法检查和验证
```
2.1 深度宪法合规性检查
   → 检查功能规范中的澄清部分完整性
   → 验证需求与项目宪法的一致性
   → 评估与现有架构原则的兼容性
   → 确认安全和合规要求的满足

2.2 智能风险评估
   → 识别潜在的技术风险和挑战
   → 评估集成复杂度和依赖风险
   → 分析性能和扩展性影响
   → 预测维护和运维复杂度

2.3 上下文驱动的需求验证
   → 验证功能需求的技术可行性
   → 检查用户故事的完整性和可测试性
   → 确认验收标准的明确性和可衡量性
   → 评估需求间的一致性和依赖关系
```

### 阶段3: 智能研究和上下文丰富
```
3.1 上下文驱动研究执行
   → 基于功能需求进行针对性技术研究
   → 分析最佳实践和行业标准
   → 研究相关的开源解决方案和库
   → 评估不同实现方案的优劣

3.2 智能模式识别和应用
   → 识别适用的设计模式和架构模式
   → 分析成功的类似实现案例
   → 提取可复用的解决方案模板
   → 适配团队的开发偏好和约定

3.3 技术决策智能支持
   → 基于上下文生成技术选型建议
   → 提供架构决策的权衡分析
   → 建议最适合的工具和框架
   → 评估技术债务和长期影响
```

### 阶段4: 智能设计生成和验证
```
4.1 加载增强计划模板
   → 加载 `templates/context-enhanced-plan-template.md`
   → 理解上下文丰富的设计要求
   → 准备智能设计生成策略

4.2 上下文驱动的设计工件生成
   → 生成 `research.md`: 深度技术研究和决策依据
     * 包含上下文特定的技术选型分析
     * 集成风险评估和缓解策略
     * 提供实现路径的详细比较
   
   → 生成 `data-model.md`: 智能数据模型设计
     * 基于现有架构的一致性设计
     * 包含性能优化和扩展性考虑
     * 集成数据验证和安全策略
   
   → 生成 `contracts/`: 智能API和接口设计
     * 基于现有API模式的一致性设计
     * 包含错误处理和版本控制策略
     * 集成安全和性能考虑
   
   → 生成 `quickstart.md`: 上下文感知的开发指南
     * 基于项目特定的开发环境和工具
     * 包含调试和测试的最佳实践
     * 提供常见问题的解决方案

4.3 验证驱动的设计审查
   → 验证设计工件的完整性和一致性
   → 检查与功能规范的对齐度
   → 评估设计的可实现性和可测试性
   → 确认与现有系统的集成兼容性
```

### 阶段5: 质量保证和智能优化
```
5.1 多层设计验证
   → 架构一致性检查
   → 性能和扩展性评估
   → 安全和合规性验证
   → 可维护性和可测试性分析

5.2 智能优化建议
   → 基于代码库分析的优化建议
   → 性能瓶颈预测和解决方案
   → 代码复用和模块化建议
   → 测试策略和覆盖率优化

5.3 风险缓解策略
   → 识别关键风险点和依赖
   → 提供具体的缓解措施
   → 建议监控和告警策略
   → 制定回滚和恢复计划
```

### 阶段6: 增强报告和任务准备
```
6.1 全面完成报告
   → 报告所有生成的设计工件
   → 总结关键的技术决策和依据
   → 列出识别的风险和缓解策略
   → 提供实施复杂度和时间估算

6.2 智能任务准备
   → 预分析任务生成的关键输入
   → 识别任务间的依赖关系
   → 建议任务优先级和执行顺序
   → 预测资源需求和技能要求
```

## Context Engineering 增强特性

### 智能技术分析
```yaml
代码库深度分析:
  - 架构模式识别和适配
  - 性能瓶颈预测和优化
  - 安全漏洞检测和防护
  - 技术债务评估和管理

智能设计生成:
  - 基于上下文的最优设计选择
  - 自动化的一致性保证
  - 预测性的扩展性设计
  - 智能的错误处理策略

验证驱动开发:
  - 多层次的设计验证
  - 自动化的质量检查
  - 持续的风险评估
  - 智能的优化建议
```

### 上下文感知的决策支持
```yaml
技术选型智能:
  - 基于项目特征的最优选择
  - 长期维护成本考虑
  - 团队技能匹配分析
  - 生态系统兼容性评估

架构决策支持:
  - 多方案对比和权衡
  - 风险收益分析
  - 演进路径规划
  - 回滚策略设计

性能优化指导:
  - 瓶颈预测和预防
  - 缓存策略优化
  - 数据库设计优化
  - 网络和I/O优化
```

### 自适应深度控制
```yaml
复杂度自适应:
  - 简单功能: 快速设计，专注核心实现
  - 中等复杂: 平衡设计，考虑扩展性
  - 高复杂度: 深度设计，全面风险管理
  - 关键系统: 极致设计，多重验证保障

项目类型适配:
  - 新项目: 强调架构基础和最佳实践
  - 扩展项目: 专注集成和一致性
  - 重构项目: 强调迁移策略和风险控制
  - 维护项目: 专注稳定性和向后兼容

团队能力匹配:
  - 新手团队: 详细指导和最佳实践
  - 经验团队: 高级模式和优化技巧
  - 专家团队: 创新方案和前沿技术
  - 混合团队: 分层指导和知识传递
```

## 使用示例

### 基础使用（自动检测复杂度）
```bash
/plan
```

### 指定分析深度
```bash
/plan [DEEP] # 深度技术分析和风险评估
/plan [ULTRA] # 极致深度分析，适用于关键系统
```

### 针对特定关注点
```bash
/plan [PERFORMANCE] # 专注性能优化和扩展性
/plan [SECURITY] # 专注安全和合规性
/plan [INTEGRATION] # 专注集成和兼容性
```

## 输出增强

### 标准输出 + Context Engineering 洞察
```markdown
✅ 实施计划生成完成
📁 功能目录: /path/to/specs/003-user-authentication-system/
📄 生成的设计工件:
   • research.md - 深度技术研究和决策分析
   • data-model.md - 智能数据模型设计
   • contracts/ - API和接口规范
   • quickstart.md - 开发环境和指南

🧠 Context Engineering 分析结果:
   • 技术复杂度: 中等 (需要安全和性能考虑)
   • 架构影响: 中等 (需要扩展现有认证模块)
   • 集成风险: 低 (与现有JWT系统兼容)
   • 性能影响: 低 (主要是数据库查询优化)

🔍 关键技术决策:
   • 认证方式: JWT + Refresh Token (基于现有架构)
   • 双因素认证: TOTP (推荐Google Authenticator兼容)
   • 密码存储: bcrypt + salt (符合安全最佳实践)
   • 数据库: 扩展现有用户表 (最小化迁移风险)

⚠️ 风险评估和缓解:
   • 高风险: 密码重置安全性 → 实施多重验证
   • 中风险: 并发登录处理 → 使用Redis锁机制
   • 低风险: 性能影响 → 数据库索引优化

🎯 实施建议:
   • 优先级: 核心认证 → 双因素 → 密码重置
   • 估算时间: 2-3周 (包含测试和文档)
   • 关键依赖: Redis缓存、邮件服务配置
   • 测试策略: 单元测试 + 集成测试 + 安全测试

📋 下一步准备:
   • 所有设计工件已生成，可以运行 /tasks
   • 建议先review contracts/目录中的API设计
   • 准备开发环境: 参考quickstart.md
```

---

**注意**: 此增强版本在保持与原始 `/plan` 命令完全兼容的同时，提供了深度的技术分析、智能的设计生成和全面的风险评估。所有设计工件都经过上下文验证和优化。